<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Kalkulation</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            background: #f7fafc;
            color: #2d3748;
            padding-top: 0;
        }
        h2 {
            margin-top: 18px;
            margin-bottom: 12px;
            text-align: center;
            font-weight: 600;
            color: #1a3b6e;
            letter-spacing: 0.5px;
            font-size: 1.35rem;
        }
        .main-flex-container {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            width: 100%;
            margin-top: 5mm;
        }
        .button-leiste {
            min-width: 200px;
            margin-right: 32px;
            margin-top: 0;
        }
        form {
            margin: 0;
        }
        .form-row {
            display: flex;
            gap: 36px;
            flex-wrap: nowrap;
            max-width: 100%;
        }
        .form-section {
            flex: 1 1 0;
            min-width: 260px;
            margin-bottom: 0;
            border-radius: 10px;
            padding: 18px 16px 8px 16px;
            margin-bottom: 0;
            box-shadow: 0 1px 2px 0 rgba(30,60,90,0.03);
            border: 1px solid #bfc9d1;
            background: #fff;
        }
        .form-section:nth-child(1) { border: 1px solid #bfc9d1; }
        .form-section:nth-child(2) { border: 1px solid #bfc9d1; }
        .form-section:nth-child(3) { border: 1px solid #bfc9d1; }
        .form-section:nth-child(4) { border: 1px solid #bfc9d1; }
        .form-section legend {
            font-weight: 600;
            color: #1a3b6e;
            padding: 0 5px;
            font-size: 14px;
            letter-spacing: 0.3px;
        }
        label {
            display: block;
            margin-top: 6px;
            font-size: 13px;
            font-weight: 500;
            color: #2e3d32;
        }
        input, select {
            margin-top: 3px;
            margin-bottom: 6px;
            padding: 4px 7px;
            border-radius: 5px;
            border: 1px solid #bfc9d1;
            font-size: 13px;
            background: #fff;
            width: 100%;
            box-sizing: border-box;
            transition: border 0.2s;
        }
        input:focus, select:focus {
            border: 1.2px solid #388e3c;
            outline: none;
        }
        input[readonly] {
            background: #e3e8ee;
            border-color: #bfc9d1;
        }
        .input-aufschlag-prozent {
            width: 60px;
            font-size: 1em;
            text-align: right;
            border: 1px solid #bfc9d1;
            border-radius: 4px;
            color: #1a3b6e;
            background: #f7fafc;
        }
        button {
            padding: 8px 18px;
            font-size: 14px;
            font-weight: 600;
            color: #fff;
            background: linear-gradient(90deg, #1a3b6e 60%, #2c5282 100%);
            border: none;
            border-radius: 7px;
            box-shadow: 0 1px 4px 0 rgba(0,0,0,0.07);
            cursor: pointer;
            margin: 18px auto 0 auto;
            display: block;
            letter-spacing: 0.3px;
            transition: background 0.2s;
        }
        button:hover {
            background: linear-gradient(90deg, #2c5282 60%, #1a3b6e 100%);
        }
        .button-row {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        .reset-button {
            background: #dc2626;
        }
        .reset-button:hover {
            background: #b91c1c;
        }
        .pdf-button {
            background: #1a3b6e;
        }
        .pdf-button:hover {
            background: #2c5282;
        }
        table {
            border-collapse: collapse;
            margin-top: 16px;
            width: 100%;
            background: #f5f7fa;
            border-radius: 8px;
            overflow: hidden;
            font-size: 1.12em;
        }
        th, td {
            border: 1px solid #bfc9d1;
            padding: 10px 14px;
            text-align: center;
        }
        td {
            color: #2d3748;
        }
        th {
            background: #e3e8ee;
            font-weight: 600;
            color: #1a3b6e;
            letter-spacing: 0.3px;
        }
        .result-section {
            margin-top: 15px;
            padding: 12px 8px 10px 8px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 1px 6px 0 rgba(30,60,90,0.05);
            border: 1px solid #bfc9d1;
            font-size: 13px;
        }
        .vk-endpreis {
            font-weight: bold;
            color: #1a3b6e;
            background: #e3e8ee;
            padding: 4px 6px;
            border-radius: 5px;
        }
        .version {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 12px;
            color: #718096;
            background: rgba(255, 255, 255, 0.8);
            padding: 4px 8px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .debug-box {
            margin-top: 8px;
            padding: 7px 10px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: bold;
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffe066;
        }
        .debug-kundendaten { background: #e3fcec; color: #276749; border-color: #38a169; }
        .debug-kalkulation { background: #e3e8ee; color: #2b6cb0; border-color: #3182ce; }
        .debug-versand { background: #fff5e6; color: #b7791f; border-color: #ed8936; }
        .debug-lagerung { background: #fce8f3; color: #97266d; border-color: #d53f8c; }
        .debug-ergebnis { background: #f7fafc; color: #1a365d; border-color: #2b6cb0; }
        @media (max-width: 1100px) {
            .form-row { flex-direction: column; max-width: 100%; }
            .form-section { min-width: 0; }
            form { max-width: 100%; margin-left: 0; }
        }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        .input-aufschlag-prozent::-webkit-inner-spin-button, .input-aufschlag-prozent::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .input-aufschlag-prozent {
            -moz-appearance: textfield;
        }
        .button-row-oben {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-start;
            width: 240px;
            margin-left: 18px;
            margin-top: 18px;
        }
        .button-row-oben a,
        .button-row-oben button {
            display: block;
            width: 100%;
            min-width: 180px;
            max-width: 100%;
            box-sizing: border-box;
            margin: 0;
            text-align: left;
            font-size: 15px;
            font-weight: 600;
            padding: 10px 18px;
            border-radius: 7px;
            background: linear-gradient(90deg, #1a3b6e 60%, #2c5282 100%);
            color: #fff;
            border: none;
            box-shadow: 0 1px 4px 0 rgba(0,0,0,0.07);
            letter-spacing: 0.3px;
            transition: background 0.2s;
            cursor: pointer;
        }
        .button-row-oben a:hover,
        .button-row-oben button:hover {
            background: linear-gradient(90deg, #2c5282 60%, #1a3b6e 100%);
        }
        .button-row-oben .reset-button {
            background: #dc2626;
        }
        .button-row-oben .reset-button:hover {
            background: #b91c1c;
        }
        .button-row-oben .pdf-button {
            background: #1a3b6e;
        }
        .button-row-oben .pdf-button:hover {
            background: #2c5282;
        }
        .header {
            background-color: #1a3b6e;
            padding: 10px 0;
        }
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        .logo {
            color: #fff;
            font-size: 1.5rem;
            font-weight: 600;
            text-decoration: none;
            position: absolute;
            left: 24px;
        }
        .seiten-titel {
            color: #fff;
            font-size: 1.3em;
            font-weight: 600;
            text-align: center;
            flex: 1;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="#" class="logo">Hausenstein</a>
            <span class="seiten-titel">Kalkulation</span>
        </div>
    </header>
    <div id="root"></div>
    <script type="text/babel">
    const API_BASE = "http://192.168.1.20:5050";
    const API_URL = 'http://192.168.1.20:5050/api/kalkulationen'; // ggf. IP anpassen!
    let kalkulationen = [];
    let sortField = null;
    let sortDir = 1;

    async function fetchKalkulationenFromServer() {
      const res = await fetch(API_URL);
      kalkulationen = await res.json();
    }

    async function addKalkulationToServer(kalkulation) {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(kalkulation)
      });
      return await res.json();
    }

    async function updateKalkulationOnServer(id, kalkulation) {
      await fetch(`${API_URL}/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(kalkulation)
      });
    }

    async function deleteKalkulationOnServer(id) {
      await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
    }

    async function renderKalkulationen() {
      await fetchKalkulationenFromServer();
      // Hier folgt die Logik zum Rendern der Kalkulationen analog zu renderTasks in Aufgabe.html
      // ...
    }

    async function addKalkulation() {
      // Sammle die Felder für eine neue Kalkulation (analog zu addTask)
      // ...
      await addKalkulationToServer({ /* Felder */ });
      renderKalkulationen();
    }

    async function updateKalkulationField(id, field, value) {
      const kalk = kalkulationen.find(k => k.id === id);
      if (!kalk) return;
      kalk[field] = value;
      await updateKalkulationOnServer(id, kalk);
      renderKalkulationen();
    }

    async function deleteKalkulation(id) {
      if (confirm("Möchtest du diese Kalkulation wirklich löschen?")) {
        await deleteKalkulationOnServer(id);
        renderKalkulationen();
      }
    }

    function sortKalkulationen(field) {
      if (sortField === field) {
        sortDir = -sortDir;
      } else {
        sortField = field;
        sortDir = 1;
      }
      renderKalkulationen();
    }

    window.addEventListener('DOMContentLoaded', renderKalkulationen);

        // Hilfsfunktion für deutsche Zahlenformatierung
        function formatDE(num) {
            return Number(num).toLocaleString("de-DE", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // Stückgutpreise nach PLZ-Range und Palettenanzahl (1-6 Paletten)
        const stueckgutPreistabelle = [
            { von: 1000, bis: 1999, preise: [75.60, 133.62, 163.67, 191.68, 250.07, 310.10] },
            { von: 2000, bis: 2600, preise: [75.60, 133.62, 163.67, 191.68, 250.07, 310.10] },
            { von: 2610, bis: 4099, preise: [72.84, 128.30, 157.35, 184.36, 240.10, 295.27] },
            { von: 4100, bis: 7999, preise: [72.84, 128.30, 157.35, 184.36, 240.10, 295.27] },
            { von: 8000, bis: 9699, preise: [75.60, 133.62, 163.67, 191.68, 250.07, 310.10] },
            { von: 9700, bis: 9999, preise: [75.60, 133.62, 163.67, 191.68, 250.07, 310.10] },
            { von: 10000, bis: 14999, preise: [75.60, 133.62, 163.67, 191.68, 250.07, 310.10] },
            { von: 15000, bis: 17999, preise: [78.26, 138.66, 169.78, 199.10, 262.65, 327.05] },
            { von: 18000, bis: 28999, preise: [75.60, 133.62, 163.67, 191.68, 250.07, 310.10] },
            { von: 29000, bis: 30999, preise: [73.09, 128.30, 157.35, 184.36, 240.10, 295.27] },
            { von: 31000, bis: 32999, preise: [73.09, 128.30, 157.35, 184.36, 240.10, 295.27] },
            { von: 33000, bis: 34999, preise: [68.87, 121.01, 148.09, 173.46, 223.65, 279.48] },
            { von: 35000, bis: 36999, preise: [66.07, 115.73, 141.30, 165.66, 217.70, 265.99] },
            { von: 37000, bis: 38999, preise: [72.84, 128.30, 157.35, 184.36, 240.10, 295.27] },
            { von: 39000, bis: 40999, preise: [68.87, 121.01, 148.09, 173.46, 223.65, 279.48] },
            { von: 41000, bis: 48999, preise: [68.87, 121.01, 148.09, 173.46, 223.65, 279.48] },
            { von: 49000, bis: 50999, preise: [72.84, 128.30, 157.35, 184.36, 240.10, 295.27] },
            { von: 51000, bis: 53999, preise: [68.87, 121.01, 148.09, 173.46, 223.65, 279.48] },
            { von: 54000, bis: 56999, preise: [52.12, 87.69, 106.69, 125.37, 175.46, 203.16] },
            { von: 57000, bis: 59999, preise: [66.07, 115.73, 141.30, 165.66, 217.70, 265.99] },
            { von: 60000, bis: 69999, preise: [52.12, 87.69, 106.69, 125.37, 175.46, 203.16] },
            { von: 70000, bis: 79999, preise: [52.12, 87.69, 106.69, 125.37, 175.46, 203.16] },
            { von: 80000, bis: 89999, preise: [66.07, 115.73, 141.30, 165.66, 217.70, 265.99] },
            { von: 90000, bis: 99999, preise: [68.87, 121.01, 148.09, 173.46, 223.65, 279.48] }
        ];

        // Neue Stückgut-Preisfunktion
        function getStueckgutPreis(plz, paletten) {
            const plzNum = parseInt((plz || '').toString().replace(/\D/g, ''));
            let pal = Math.max(1, Math.min(6, parseInt(paletten) || 1));
            const eintrag = stueckgutPreistabelle.find(e => plzNum >= e.von && plzNum <= e.bis);
            if (eintrag) {
                const basis = eintrag.preise[pal-1];
                const preiserhoehung = basis * 0.0559;
                const basisMitPreiserhoehung = basis + preiserhoehung;
                const dieselzuschlag = basisMitPreiserhoehung * 0.1526;
                const palettentausch = pal * 3.80;
                const versicherung = 2.90;
                return {
                    basis: basis,
                    maut: 0,
                    palettentausch: palettentausch,
                    dieselzuschlag: dieselzuschlag,
                    versicherung: versicherung,
                    preiserhoehung: preiserhoehung,
                    paletten: pal
                };
            }
            // Fallback
            const basis = 100;
            const preiserhoehung = basis * 0.0559;
            const basisMitPreiserhoehung = basis + preiserhoehung;
            const dieselzuschlag = basisMitPreiserhoehung * 0.1526;
            const palettentausch = pal * 3.80;
            const versicherung = 2.90;
            return {
                basis: basis,
                maut: 0,
                palettentausch: palettentausch,
                dieselzuschlag: dieselzuschlag,
                versicherung: versicherung,
                preiserhoehung: preiserhoehung,
                paletten: pal
            };
        }

        function App() {
            // States
            const [interneNummer, setInterneNummer] = React.useState("");
            const [kundenname, setKundenname] = React.useState("");
            const [ek, setEk] = React.useState("");
            const [preiseinheit, setPreiseinheit] = React.useState("1000");
            const [menge, setMenge] = React.useState("");
            const [stueckProPalette, setStueckProPalette] = React.useState("");
            const [aufschlag, setAufschlag] = React.useState("");
            const [vkWunsch, setVkWunsch] = React.useState("");
            const [versandart, setVersandart] = React.useState("lkw");
            const [strecke, setStrecke] = React.useState("");
            const [spedition, setSpedition] = React.useState("");
            const [plz, setPlz] = React.useState("");
            const [lieferantenSkonto, setLieferantenSkonto] = React.useState("2");
            const [skonto, setSkonto] = React.useState("2");
            const [artikelListe, setArtikelListe] = React.useState([]);
            const [gesamtMenge, setGesamtMenge] = React.useState(0);
            const [sendungsVersandkosten, setSendungsVersandkosten] = React.useState(0);
            const [vergleiche, setVergleiche] = React.useState([]);
            const [versandAktiv, setVersandAktiv] = React.useState(false);
            const [lagerPaletten, setLagerPaletten] = React.useState("");
            const [lagerDauer, setLagerDauer] = React.useState("");
            const [lagerGebuehr] = React.useState(5.5);
            const [dummyState, setDummyState] = React.useState(0);
            const [savedCalculations, setSavedCalculations] = React.useState([]);
            const [searchQuery, setSearchQuery] = React.useState("");
            const [showDatabase, setShowDatabase] = React.useState(false);

            // Versand aktivieren, sobald mindestens ein Artikel in der Sendung ist
            React.useEffect(() => {
                setVersandAktiv(artikelListe.length > 0);
            }, [artikelListe]);

            // Frachtkostenberechnung in Echtzeit
            const berechneFrachtkosten = React.useCallback(() => {
                const mengeNum = parseFloat(menge) || 0;
                const stueckProPaletteNum = parseFloat(stueckProPalette) || 0;
                // Für alle Versandarten: immer die gesamte Palettenanzahl aus der Sendung nehmen
                let anzahlPaletten = 1;
                if (artikelListe.length > 0) {
                    anzahlPaletten = artikelListe.reduce((sum, a) => sum + (a.anzahlPaletten || 0), 0);
                } else if (mengeNum > 0 && stueckProPaletteNum > 0) {
                    anzahlPaletten = Math.ceil(mengeNum / stueckProPaletteNum);
                }

                let versandkosten = 0;
                let basisKosten = 0;
                let mautKosten = 0;
                let palettentausch = 0;
                let dieselzuschlag = 0;
                let versicherung = 0;
                let preiserhoehung = 0;
                let stueckgutHinweis = "";

                if (versandart === "lkw") {
                    versandkosten = (parseFloat(strecke) || 0) * 2 * 1.2;
                    if (anzahlPaletten > 15) {
                        stueckgutHinweis = "Achtung: LKW kann maximal 15 Paletten transportieren!";
                    }
                } else if (versandart === "lkwZug") {
                    versandkosten = (parseFloat(strecke) || 0) * 2 * 1.6;
                    if (anzahlPaletten > 33) {
                        stueckgutHinweis = "Achtung: LKW Zug kann maximal 33 Paletten transportieren!";
                    }
                } else if (versandart === "bus") {
                    versandkosten = (parseFloat(strecke) || 0) * 2 * 0.8;
                } else if (versandart === "spedition") {
                    versandkosten = parseFloat(spedition) || 0;
                } else if (versandart === "stueckgut") {
                    if (anzahlPaletten > 6) {
                        stueckgutHinweis = "Maximal 6 Paletten pro Sendung bei Stückgut! Es werden nur 6 Paletten berechnet.";
                        anzahlPaletten = 6;
                    }
                    const stueckgutPreis = getStueckgutPreis(plz, anzahlPaletten);
                    basisKosten = stueckgutPreis.basis;
                    preiserhoehung = stueckgutPreis.preiserhoehung;
                    palettentausch = stueckgutPreis.palettentausch;
                    dieselzuschlag = stueckgutPreis.dieselzuschlag;
                    versicherung = stueckgutPreis.versicherung;
                    const basisMitPreiserhoehung = basisKosten + preiserhoehung;
                    mautKosten = +(basisKosten * 0.0794).toFixed(2); // 7,94% des Basispreises
                    versandkosten = basisMitPreiserhoehung + palettentausch + dieselzuschlag + versicherung + mautKosten;
                }

                return {
                    gesamt: versandkosten,
                    basis: basisKosten,
                    maut: mautKosten,
                    palettentausch: palettentausch,
                    dieselzuschlag: dieselzuschlag,
                    versicherung: versicherung,
                    preiserhoehung: preiserhoehung,
                    paletten: anzahlPaletten,
                    stueckgutHinweis: stueckgutHinweis
                };
            }, [versandart, strecke, spedition, plz, menge, stueckProPalette, artikelListe]);

            const frachtkosten = berechneFrachtkosten();

            // Einzelartikel-Kalkulation in Echtzeit
            const berechneErgebnis = React.useCallback(() => {
                const ekNum = parseFloat(ek) || 0;
                const einheit = parseFloat(preiseinheit) || 1;
                const aufschlagNum = parseFloat(aufschlag) || 0;
                const vkNum = parseFloat(vkWunsch) || 0;
                const mengeNum = parseFloat(menge) || 0;
                const stueckProPaletteNum = parseFloat(stueckProPalette) || 0;

                let anzahlPaletten = 0;
                if (mengeNum > 0 && stueckProPaletteNum > 0) {
                    anzahlPaletten = Math.ceil(mengeNum / stueckProPaletteNum);
                }

                // Versandkosten für Einzelartikel
                let versandkosten = frachtkosten.gesamt;

                // VK/Endpreis je Preiseinheit
                let vkJePreiseinheit = 0;
                let vkInklVersandJePreiseinheit = 0;
                if (vkWunsch) {
                    vkInklVersandJePreiseinheit = vkNum;
                    let versandProPreiseinheit = mengeNum > 0 ? versandkosten * (einheit / mengeNum) : 0;
                    vkJePreiseinheit = vkInklVersandJePreiseinheit - versandProPreiseinheit;
                } else if (aufschlag) {
                    vkJePreiseinheit = ekNum * (1 + aufschlagNum / 100);
                    vkInklVersandJePreiseinheit = vkJePreiseinheit + (mengeNum > 0 ? versandkosten * (einheit / mengeNum) : 0);
                }

                // Aufschlag in %
                let aufschlagProzent = ekNum > 0 ? ((vkInklVersandJePreiseinheit - ekNum) / ekNum) * 100 : 0;

                // Gesamter EK und VK
                const gesamtEK = ekNum * (mengeNum / einheit);
                const gesamtVK = vkJePreiseinheit * (mengeNum / einheit);

                // Deckungsbeitrag je Preiseinheit und gesamt
                const dbJePreiseinheit = vkJePreiseinheit - ekNum;
                const anzahlPreiseinheiten = mengeNum / einheit;
                const dbGesamt = dbJePreiseinheit * anzahlPreiseinheiten;

                return {
                    ekJePreiseinheit: ekNum,
                    versandkosten,
                    vkJePreiseinheit,
                    vkInklVersandJePreiseinheit,
                    dbJePreiseinheit,
                    dbGesamt,
                    anzahlPaletten,
                    mengeNum,
                    einheit,
                    aufschlagProzent,
                    gesamtEK,
                    gesamtVK
                };
            }, [ek, preiseinheit, aufschlag, vkWunsch, menge, stueckProPalette, frachtkosten.gesamt]);

            const aktuellesErgebnis = berechneErgebnis();

            // Lagerkosten-Berechnung
            const berechneLagerkosten = React.useCallback(() => {
                const paletten = aktuellesErgebnis.anzahlPaletten || 0;
                const monate = parseInt(lagerDauer) || 0;
                const gebuehr = 5.5;
                if (paletten === 0 || monate === 0 || gebuehr === 0) return { gesamt: 0, proEinheit: 0 };
                let summe = 0;
                for (let m = 0; m < monate; m++) {
                    summe += (paletten - m > 0 ? paletten - m : 0) * gebuehr;
                }
                // Auf VK gesamt verteilen (auf alle Preiseinheiten)
                const vkGesamt = aktuellesErgebnis.gesamtVK || 0;
                const menge = aktuellesErgebnis.mengeNum || 0;
                const einheit = aktuellesErgebnis.einheit || 1;
                const proEinheit = menge > 0 ? summe / (menge / einheit) : 0;
                return { gesamt: summe, proEinheit };
            }, [lagerDauer, aktuellesErgebnis]);
            const lagerkosten = berechneLagerkosten();

            function resetForm() {
                setInterneNummer("");
                setKundenname("");
                setEk("");
                setPreiseinheit("1000");
                setMenge("");
                setStueckProPalette("");
                setAufschlag("");
                setVkWunsch("");
                setVersandart("lkw");
                setStrecke("");
                setSpedition("");
                setPlz("");
                setLieferantenSkonto("2");
                setSkonto("2");
                setArtikelListe([]); // Artikelliste leeren
                setGesamtMenge(0);
                setSendungsVersandkosten(0); // Versandkosten zurücksetzen
                setVergleiche([]);
                setVersandAktiv(false);
                setLagerPaletten("");
                setLagerDauer("");
                setDummyState(s => s + 1); // Re-Render erzwingen
            }

            // Artikel zur Sendung hinzufügen
            function artikelZurSendungHinzufuegen() {
                if (aktuellesErgebnis) {
                    const artikel = {
                        ...aktuellesErgebnis,
                        interneNummer,
                        kundenname,
                        menge: parseFloat(menge) || 0,
                        einheit: parseFloat(preiseinheit) || 1,
                        lagerkostenProEinheit: lagerkosten.proEinheit
                    };
                    setArtikelListe(prev => [...prev, artikel]);
                    setGesamtMenge(prev => prev + (parseFloat(menge) || 0));
                    setInterneNummer("");
                    setKundenname("");
                    setEk("");
                    setMenge("");
                    setStueckProPalette("");
                    setAufschlag("");
                    setVkWunsch("");
                    setErgebnis(null);
                    if (!versandAktiv) setVersandAktiv(true);
                }
            }

            // Versandkosten für die gesamte Sendung berechnen (aus aktuellem Formular)
            function berechneSendungsVersandkosten() {
                let versandkosten = 0;
                if (versandart === "lkw") {
                    versandkosten = (parseFloat(strecke) || 0) * 2 * 1.2;
                    // Prüfe auf maximale Palettenanzahl
                    let gesamtPaletten = artikelListe.reduce((sum, a) => sum + (a.anzahlPaletten || 0), 0);
                    if (gesamtPaletten > 15) {
                        alert("Achtung: LKW kann maximal 15 Paletten transportieren!");
                    }
                } else if (versandart === "lkwZug") {
                    versandkosten = (parseFloat(strecke) || 0) * 2 * 1.6;
                    // Prüfe auf maximale Palettenanzahl
                    let gesamtPaletten = artikelListe.reduce((sum, a) => sum + (a.anzahlPaletten || 0), 0);
                    if (gesamtPaletten > 33) {
                        alert("Achtung: LKW Zug kann maximal 33 Paletten transportieren!");
                    }
                } else if (versandart === "bus") {
                    versandkosten = (parseFloat(strecke) || 0) * 2 * 0.8;
                } else if (versandart === "spedition") {
                    versandkosten = parseFloat(spedition) || 0;
                } else if (versandart === "stueckgut") {
                    // Gesamtpalettenzahl aller Artikel berechnen (max. 6)
                    let gesamtPaletten = artikelListe.reduce((sum, a) => sum + (a.anzahlPaletten || 0), 0);
                    if (gesamtPaletten > 6) gesamtPaletten = 6;
                    const stueckgutPreis = getStueckgutPreis(plz, gesamtPaletten);
                    const basisMitPreiserhoehung = stueckgutPreis.basis + stueckgutPreis.preiserhoehung;
                    versandkosten = basisMitPreiserhoehung + stueckgutPreis.dieselzuschlag + stueckgutPreis.palettentausch + stueckgutPreis.versicherung;
                }
                setSendungsVersandkosten(versandkosten);
            }

            // Versandkosten-Anteil pro Artikel berechnen
            let summeAnteiligeFracht = 0;
            const gesamtPaletten = artikelListe.reduce((sum, a) => sum + (a.anzahlPaletten || 0), 0) || 1;
            const artikelMitFracht = artikelListe.map((artikel, idx) => {
                let anteiligeFracht = 0;
                // Für Stückgut: immer frachtkosten.gesamt als Basis nehmen
                const gesamtFracht = versandart === "stueckgut" ? frachtkosten.gesamt : sendungsVersandkosten;
                if (artikelListe.length === 1) {
                    anteiligeFracht = gesamtFracht;
                } else {
                    const anteil = gesamtPaletten > 0 ? ((artikel.anzahlPaletten || 0) / gesamtPaletten) : 0;
                    if (idx < artikelListe.length - 1) {
                        anteiligeFracht = Math.round((gesamtFracht * anteil) * 100) / 100;
                        summeAnteiligeFracht += anteiligeFracht;
                    } else {
                        anteiligeFracht = Math.round((gesamtFracht - summeAnteiligeFracht) * 100) / 100;
                    }
                }
                const ek = artikel.ekJePreiseinheit || 0;
                const aufschlag = artikel.aufschlagProzent || 0;
                const neueVkJePE = ek * (1 + aufschlag / 100);
                const mengeNum = artikel.mengeNum || 1;
                const einheit = artikel.einheit || 1;
                const vkEndpreisMitFracht = neueVkJePE + (anteiligeFracht / (mengeNum / einheit));
                const dbJePE = neueVkJePE - ek;
                const dbGesamt = dbJePE * (mengeNum / einheit);
                return {
                    ...artikel,
                    anteiligeFracht,
                    vkEndpreisMitFracht,
                    dbJePreiseinheit: dbJePE,
                    dbGesamt
                };
            });

            // Vergleichstabelle: Ergebnisse übertragen
            function ergebnisInVergleichUebernehmen() {
                if (aktuellesErgebnis) {
                    setVergleiche(prev => [...prev, {
                        ...aktuellesErgebnis,
                        interneNummer,
                        kundenname
                    }]);
                }
            }

            // PDF-Export-Funktion für Artikelliste
            function exportierePDF() {
                const element = document.getElementById("artikel-tabelle");
                if (!element) return;
                // Auch das table-Element und den Tabellen-Container anpassen
                const table = element.querySelector('table');
                const tableContainer = element.querySelector('div');
                // Alte Werte speichern
                const oldWidth = element.style.width;
                const oldOverflow = element.style.overflowX;
                const oldTableWidth = table ? table.style.width : '';
                const oldTableContainerWidth = tableContainer ? tableContainer.style.width : '';
                const oldTableContainerOverflow = tableContainer ? tableContainer.style.overflowX : '';
                const oldTableContainerMarginLeft = tableContainer ? tableContainer.style.marginLeft : '';
                const oldTableContainerMaxWidth = tableContainer ? tableContainer.style.maxWidth : '';
                // Speichere alte Werte der ersten Spalte
                let ths = [];
                let tds = [];
                let oldThWidths = [];
                let oldTdWidths = [];
                if (table) {
                  ths = Array.from(table.querySelectorAll('th:first-child'));
                  tds = Array.from(table.querySelectorAll('td:first-child'));
                  oldThWidths = ths.map(th => ({ width: th.style.width, minWidth: th.style.minWidth }));
                  oldTdWidths = tds.map(td => ({ width: td.style.width, minWidth: td.style.minWidth }));
                  ths.forEach(th => { th.style.width = '110px'; th.style.minWidth = '110px'; });
                  tds.forEach(td => { td.style.width = '110px'; td.style.minWidth = '110px'; });
                }
                // Auf volle Breite setzen
                element.style.width = 'auto';
                element.style.overflowX = 'visible';
                if (table) table.style.width = 'auto';
                if (tableContainer) {
                  tableContainer.style.width = '100%';
                  tableContainer.style.overflowX = 'visible';
                  tableContainer.style.marginLeft = '0';
                  tableContainer.style.maxWidth = 'none';
                }
                window.html2canvas(element, { scale: 2 }).then(canvas => {
                    // Nach Screenshot zurücksetzen
                    element.style.width = oldWidth;
                    element.style.overflowX = oldOverflow;
                    if (table) table.style.width = oldTableWidth;
                    if (tableContainer) {
                      tableContainer.style.width = oldTableContainerWidth;
                      tableContainer.style.overflowX = oldTableContainerOverflow;
                      tableContainer.style.marginLeft = oldTableContainerMarginLeft;
                      tableContainer.style.maxWidth = oldTableContainerMaxWidth;
                    }
                    // Setze Spaltenbreiten zurück
                    if (table) {
                      ths.forEach((th, i) => { th.style.width = oldThWidths[i].width; th.style.minWidth = oldThWidths[i].minWidth; });
                      tds.forEach((td, i) => { td.style.width = oldTdWidths[i].width; td.style.minWidth = oldTdWidths[i].minWidth; });
                    }
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new window.jspdf.jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });
                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const pageHeight = pdf.internal.pageSize.getHeight();
                    // Tabelle in Originalgröße (keine zusätzliche Verkleinerung)
                    const scaleFactor = 1;
                    const imgWidth = (pageWidth - 20) * scaleFactor;
                    const imgHeight = canvas.height * (imgWidth / canvas.width);
                    let y = 20;
                    let finalImgWidth = imgWidth;
                    let finalImgHeight = imgHeight;
                    if (imgHeight > pageHeight - 40) {
                        finalImgHeight = (pageHeight - 40) * scaleFactor;
                        finalImgWidth = canvas.width * (finalImgHeight / canvas.height);
                        y = (pageHeight - finalImgHeight) / 2;
                    }
                    pdf.addImage(imgData, 'PNG', (pageWidth - finalImgWidth) / 2, y, finalImgWidth, finalImgHeight);
                    pdf.save('artikel-in-der-sendung.pdf');
                });
            }

            // Hilfsfunktion für eindeutige ID
            function generateKalkulationId() {
                return Date.now().toString() + Math.floor(Math.random()*10000).toString();
            }

            // Speichern
            async function saveKalkulation() {
                // Eindeutige ID für die Kalkulation
                const kalkulation_id = generateKalkulationId();
                const datum = new Date().toLocaleString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                const artikelListe = artikelMitFracht; // alle Artikel mit Fracht und Details
                try {
                    const response = await fetch('http://192.168.1.20:5050/api/kalkulationen', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ kalkulation_id, datum, artikelListe })
                    });
                    const data = await response.json();
                    if (data.status === 'success') {
                        alert('Kalkulation erfolgreich gespeichert!');
                        await loadKalkulationen();
                        resetForm();
                    }
                } catch (error) {
                    alert('Fehler beim Speichern!');
                }
            }

            // Laden
            async function loadKalkulationen() {
                try {
                    const response = await fetch('http://192.168.1.20:5050/api/kalkulationen');
                    const data = await response.json();
                    setSavedCalculations(data);
                } catch (error) {
                    alert('Fehler beim Laden!');
                }
            }

            // Suche
            const filteredCalculations = savedCalculations.filter(calc =>
                (!searchQuery ||
                    (calc.kunde && calc.kunde.toLowerCase().includes(searchQuery.toLowerCase())) ||
                    (calc.beschreibung && calc.beschreibung.toLowerCase().includes(searchQuery.toLowerCase())) ||
                    (calc.material && calc.material.toLowerCase().includes(searchQuery.toLowerCase()))
                )
            );

            // Beim ersten Rendern laden
            React.useEffect(() => { loadKalkulationen(); }, []);

            // Kompakte Datenbank-Übersichtstabelle (gruppiert, mit Checkboxen zum Löschen)
            function DatabaseTable() {
                const [selectedRows, setSelectedRows] = React.useState([]);
                const [deleteError, setDeleteError] = React.useState("");
                // Alle Artikel aus allen Kalkulationen in einer Liste sammeln
                const allArtikel = savedCalculations.flatMap(kalk => kalk.artikel);
                const handleCheckboxChange = React.useCallback((id, checked) => {
                    setSelectedRows(prev => {
                        if (checked) {
                            return [...prev, id];
                        } else {
                            return prev.filter(rowId => rowId !== id);
                        }
                    });
                }, []);

                const handleDeleteSelected = React.useCallback(async () => {
                    try {
                        if (selectedRows.length === 0) return;
                        if (!window.confirm('Ausgewählte Einträge wirklich löschen?')) return;
                        let errors = [];
                        for (const id of selectedRows) {
                            try {
                                const res = await fetch(`http://192.168.1.20:5050/api/kalkulationen/${id}`, {
                                    method: 'DELETE',
                                    headers: { 'Content-Type': 'application/json' }
                                });
                                if (!res.ok) errors.push(id);
                            } catch (err) {
                                errors.push(id);
                            }
                        }
                        setSelectedRows([]);
                        await loadKalkulationen();
                        if (errors.length === 0) {
                            setDeleteError("");
                            alert('Löschen erfolgreich!');
                        } else {
                            setDeleteError('Folgende Einträge konnten nicht gelöscht werden: ' + errors.join(", "));
                        }
                    } catch (e) {
                        console.log("Fehler beim Löschen:", e);
                        setDeleteError("Fehler beim Löschen: " + e.message);
                    }
                }, [selectedRows]);

                const handleLoadSelected = React.useCallback(() => {
                    if (selectedRows.length === 0) return;
                    // Finde alle ausgewählten Artikel
                    const selectedArtikel = [];
                    savedCalculations.forEach(kalk => {
                        kalk.artikel.forEach(row => {
                            if (selectedRows.includes(row.id)) {
                                selectedArtikel.push({
                                    interneNummer: row.angebotsnummer || '',
                                    kundenname: row.kundenname || '',
                                    ekJePreiseinheit: row.ek_je_pe || 0,
                                    mengeNum: row.menge || 0,
                                    anzahlPaletten: row.paletten || 0,
                                    aufschlagProzent: row.aufschlag || 0,
                                    einheit: 1000, // Standardwert, ggf. anpassen
                                    anteiligeFracht: row.anteilige_fracht || 0,
                                    lagerkostenProEinheit: 0 // Standardwert, ggf. anpassen
                                });
                            }
                        });
                    });
                    setArtikelListe(selectedArtikel);
                    // Optional: Datenbank-Ansicht schließen
                    // setShowDatabase(false);
                }, [selectedRows, savedCalculations]);

                return (
                    <div style={{ marginTop: 20, padding: 20, background: '#fff', borderRadius: 8, boxShadow: '0 1px 3px rgba(0,0,0,0.1)' }}>
                        <h2 style={{fontSize:'15px'}}>Datenbank-Übersicht</h2>
                        {deleteError && (
                            <div style={{color: 'red', fontWeight: 'bold', marginBottom: 10}}>
                                {deleteError}
                            </div>
                        )}
                        <div style={{display:'flex',justifyContent:'flex-end',gap:10,marginBottom:10}}>
                            <button 
                                type="button"
                                onClick={handleLoadSelected}
                                disabled={selectedRows.length === 0}
                                style={{
                                    background: selectedRows.length === 0 ? '#ccc' : '#1a3b6e',
                                    color: '#fff',
                                    fontWeight: 'bold',
                                    border: 'none',
                                    borderRadius: 5,
                                    padding: '5px 12px',
                                    fontSize: '13px',
                                    cursor: selectedRows.length === 0 ? 'not-allowed' : 'pointer'
                                }}
                            >
                                Ausgewählte laden
                            </button>
                            <button 
                                type="button"
                                onClick={handleDeleteSelected} 
                                disabled={selectedRows.length === 0}
                                style={{
                                    background: selectedRows.length === 0 ? '#ccc' : '#dc2626',
                                    color: '#fff',
                                    fontWeight: 'bold',
                                    border: 'none',
                                    borderRadius: 5,
                                    padding: '5px 12px',
                                    fontSize: '13px',
                                    cursor: selectedRows.length === 0 ? 'not-allowed' : 'pointer'
                                }}
                            >
                                Ausgewählte löschen
                            </button>
                        </div>
                        <table style={{ width: '100%', borderCollapse: 'collapse', fontSize:'13px' }}>
                            <thead>
                                <tr style={{ background: '#e3e8ee', color: '#1a3b6e' }}>
                                    <th style={{width: '30px'}}></th>
                                    <th>Angebotsnummer</th>
                                    <th>Kundenname</th>
                                    <th>Menge</th>
                                    <th>Paletten</th>
                                    <th>EK je PE</th>
                                    <th>Einkaufssumme</th>
                                    <th>Verkaufssumme</th>
                                    <th>VK je PE</th>
                                    <th>Aufschlag %</th>
                                    <th>anteilige Fracht</th>
                                    <th>DB gesamt</th>
                                </tr>
                            </thead>
                            <tbody>
                                {allArtikel.map(row => (
                                    <tr key={row.id} style={{ borderBottom: '1px solid #bfc9d1' }}>
                                        <td style={{textAlign: 'center'}}>
                                            <input 
                                                type="checkbox" 
                                                checked={selectedRows.includes(row.id)} 
                                                onChange={e => handleCheckboxChange(row.id, e.target.checked)}
                                                style={{ 
                                                    cursor: 'pointer',
                                                    width: '16px',
                                                    height: '16px'
                                                }}
                                            />
                                        </td>
                                        <td>{row.angebotsnummer}</td>
                                        <td>{row.kundenname}</td>
                                        <td>{row.menge}</td>
                                        <td>{row.paletten}</td>
                                        <td>€{formatDE(row.ek_je_pe)}</td>
                                        <td>€{formatDE(row.einkaufssumme)}</td>
                                        <td>€{formatDE(row.verkaufssumme)}</td>
                                        <td>€{formatDE(row.vk_je_pe)}</td>
                                        <td>{row.aufschlag}</td>
                                        <td>{row.anteilige_fracht > 0 ? '€' + formatDE(row.anteilige_fracht) : '-'}</td>
                                        <td>€{formatDE(row.db_gesamt)}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                );
            }

            // Button-Leiste oben (jetzt innerhalb von React)
            const ButtonLeiste = () => (
                <div className="button-row-oben">
                    <a href="index.html" style={{ textDecoration: 'none', color: '#fff', background: '#1a3b6e', borderRadius: 7, padding: '10px 18px', fontWeight: 600, display: 'block', marginBottom: 8 }}>
                        ← Zurück zur Startseite
                    </a>
                    <button type="button" className="pdf-button" onClick={exportierePDF}>Als PDF exportieren</button>
                    <button type="button" className="reset-button" onClick={resetForm}>Formular zurücksetzen</button>
                </div>
            );

            return (
                <div className="main-flex-container">
                    <div className="button-leiste">
                        <ButtonLeiste />
                    </div>
                    <form onSubmit={berechneErgebnis}>
                        <div className="form-row">
                            <fieldset className="form-section">
                                <legend>Kundendaten</legend>
                                <label>Interne Angebotsnummer:
                                    <input type="text" value={interneNummer} onChange={e => setInterneNummer(e.target.value)} placeholder="z.B. AN-001" style={{ borderColor: !interneNummer.trim() ? '#dc2626' : undefined }} tabIndex={1} />
                                    {!interneNummer.trim() && <span style={{color:'#dc2626',fontSize:'12px'}}>Bitte ausfüllen</span>}
                                </label>
                                <label>Kundenname:
                                    <input type="text" value={kundenname} onChange={e => setKundenname(e.target.value)} placeholder="Kundenname" style={{ borderColor: !kundenname.trim() ? '#dc2626' : undefined }} tabIndex={2} />
                                    {!kundenname.trim() && <span style={{color:'#dc2626',fontSize:'12px'}}>Bitte ausfüllen</span>}
                                </label>
                                <div className="result-section" style={{ marginTop: "15px" }}>
                                    <div style={{ marginBottom: "15px" }}>
                                        <strong>VK je PE:</strong> €{formatDE(aktuellesErgebnis.vkJePreiseinheit + lagerkosten.proEinheit)}<br />
                                        <span style={{
                                            display: 'inline-block',
                                            background: '#e3e8ee',
                                            color: '#1a3b6e',
                                            fontWeight: 'bold',
                                            fontSize: '1.15em',
                                            padding: '3px 10px',
                                            borderRadius: '6px',
                                            margin: '6px 0 6px 0'
                                        }}>
                                            VK: €{formatDE(aktuellesErgebnis.vkInklVersandJePreiseinheit + lagerkosten.proEinheit)}
                                        </span><br />
                                        <strong>DB gesamt:</strong> €{formatDE(aktuellesErgebnis.dbGesamt - lagerkosten.gesamt)}<br />
                                        <strong>Paletten:</strong> {aktuellesErgebnis.anzahlPaletten}<br />
                                        <strong>Frachtkosten (Sendung):</strong> €{
                                            versandart === "stueckgut" && artikelMitFracht.length > 0
                                                ? formatDE(artikelMitFracht.reduce((sum, a) => sum + (a.anteiligeFracht || 0), 0))
                                                : formatDE(sendungsVersandkosten)
                                        }<br />
                                        <span style={{ color: '#1a3b6e' }}>
                                            Lager gesamt: <strong>€{formatDE(lagerkosten.gesamt)}</strong> | je PE: <strong>€{formatDE(lagerkosten.proEinheit)}</strong>
                                        </span>
                                    </div>
                                    <button
                                        type="button"
                                        onClick={artikelZurSendungHinzufuegen}
                                        style={{
                                            width: "100%",
                                            fontWeight: "bold",
                                            background: "linear-gradient(90deg, #1a3b6e 60%, #2c5282 100%)",
                                            color: "#fff",
                                            border: "none",
                                            borderRadius: "7px",
                                            padding: "8px 18px",
                                            cursor: "pointer"
                                        }}
                                        tabIndex={7}
                                    >
                                        Artikel zur Sendung hinzufügen
                                    </button>
                                </div>
                            </fieldset>
                            <fieldset className="form-section">
                                <legend>Kalkulation</legend>
                                <label>EK je Preiseinheit:
                                    <input type="number" value={ek} onChange={e => setEk(e.target.value)} step="0.01" tabIndex={3} />
                                </label>
                                <label>Preiseinheit:
                                    <select value={preiseinheit} onChange={e => setPreiseinheit(e.target.value)} tabIndex={-1}>
                                        <option value="1">1</option>
                                        <option value="100">100</option>
                                        <option value="1000">1.000</option>
                                    </select>
                                </label>
                                <label>Menge:
                                    <input type="number" value={menge} onChange={e => setMenge(e.target.value)} tabIndex={4} />
                                </label>
                                <label>Stück pro Palette:
                                    <input type="number" value={stueckProPalette} onChange={e => setStueckProPalette(e.target.value)} tabIndex={5} />
                                </label>
                                <label>Aufschlag in %:
                                    <input type="number" value={aufschlag} onChange={e => setAufschlag(e.target.value)} step="0.01" tabIndex={6} />
                                </label>
                                <label>VK Wunschpreis:
                                    <input type="number" value={vkWunsch} onChange={e => setVkWunsch(e.target.value)} step="0.01" tabIndex={-1} />
                                </label>
                            </fieldset>
                            <fieldset className="form-section"
                                style={versandAktiv ? {} : { position: 'relative', opacity: 0.6 }}
                            >
                                <legend>Versand</legend>
                                <label>Versandart:
                                    <select value={versandart} onChange={e => setVersandart(e.target.value)} disabled={!versandAktiv}>
                                        <option value="lkw">LKW (max. 15 Paletten)</option>
                                        <option value="lkwZug">LKW Zug (33 Paletten)</option>
                                        <option value="bus">Bus</option>
                                        <option value="spedition">Spedition</option>
                                        <option value="stueckgut">Stückgut</option>
                                    </select>
                                </label>
                                {(versandart === "lkw" || versandart === "lkwZug" || versandart === "bus") && (
                                    <label>Strecke (km):
                                        <input type="number" value={strecke} onChange={e => setStrecke(e.target.value)} disabled={!versandAktiv} />
                                    </label>
                                )}
                                {versandart === "spedition" && (
                                    <label>Speditionskosten:
                                        <input type="number" value={spedition} onChange={e => setSpedition(e.target.value)} step="0.01" disabled={!versandAktiv} />
                                    </label>
                                )}
                                {versandart === "stueckgut" && (
                                    <label>PLZ:
                                        <input type="text" value={plz} onChange={e => setPlz(e.target.value)} disabled={!versandAktiv} />
                                    </label>
                                )}
                                <div style={{
                                    marginTop: "15px",
                                    padding: "10px",
                                    background: "#fff",
                                    border: "1px solid #bfc9d1",
                                    borderRadius: "5px",
                                    fontSize: "13px"
                                }}>
                                    <div style={{ 
                                        color: "#1a3b6e", 
                                        fontWeight: "600",
                                        marginBottom: "5px",
                                        borderBottom: "1px solid #e3e8ee",
                                        paddingBottom: "5px"
                                    }}>
                                        Frachtkosten
                                    </div>
                                    {versandart === "stueckgut" && frachtkosten.stueckgutHinweis && (
                                        <div style={{ color: "#b91c1c", fontWeight: "bold", marginBottom: "8px" }}>
                                            {frachtkosten.stueckgutHinweis}
                                        </div>
                                    )}
                                    <div style={{ textAlign: "right" }}>
                                        <strong>Gesamt:</strong> €{formatDE(frachtkosten.gesamt)}
                                    </div>
                                    {versandart === "stueckgut" && frachtkosten.basis > 0 && (
                                        <>
                                            <div style={{ textAlign: "right", fontSize: "12px", color: "#666" }}>
                                                Basis: €{formatDE(frachtkosten.basis)}
                                            </div>
                                            <div style={{ textAlign: "right", fontSize: "12px", color: "#666" }}>
                                                Dieselzuschlag (15,26%): €{formatDE(frachtkosten.dieselzuschlag)}
                                            </div>
                                            <div style={{ textAlign: "right", fontSize: "12px", color: "#666" }}>
                                                Palettentausch: €{formatDE(frachtkosten.palettentausch)}
                                            </div>
                                            <div style={{ textAlign: "right", fontSize: "12px", color: "#666" }}>
                                                Versicherung: €{formatDE(frachtkosten.versicherung)}
                                            </div>
                                            <div style={{ textAlign: "right", fontSize: "12px", color: "#666" }}>
                                                Preiserhöhung (5,59%): €{formatDE(frachtkosten.preiserhoehung)}
                                            </div>
                                            <div style={{ textAlign: "right", fontSize: "12px", color: "#666" }}>
                                                gesetzl. Maut (7,94%): €{formatDE(frachtkosten.maut)}
                                            </div>
                                        </>
                                    )}
                                    {versandart === "lkw" && (
                                        <>
                                            <div style={{ textAlign: "right", fontSize: "12px", color: "#666" }}>
                                                Preis pro km: €1,20
                                            </div>
                                            <div style={{ textAlign: "right", fontSize: "12px", color: "#666" }}>
                                                Hin- und Rückfahrt: {parseFloat(strecke) || 0} km × 2
                                            </div>
                                        </>
                                    )}
                                    {versandart === "lkwZug" && (
                                        <>
                                            <div style={{ textAlign: "right", fontSize: "12px", color: "#666" }}>
                                                Preis pro km: €1,60
                                            </div>
                                            <div style={{ textAlign: "right", fontSize: "12px", color: "#666" }}>
                                                Hin- und Rückfahrt: {parseFloat(strecke) || 0} km × 2
                                            </div>
                                        </>
                                    )}
                                    {versandart === "bus" && (
                                        <>
                                            <div style={{ textAlign: "right", fontSize: "12px", color: "#666" }}>
                                                Preis pro km: €0,80
                                            </div>
                                            <div style={{ textAlign: "right", fontSize: "12px", color: "#666" }}>
                                                Hin- und Rückfahrt: {parseFloat(strecke) || 0} km × 2
                                            </div>
                                        </>
                                    )}
                                    {frachtkosten.paletten > 0 && (
                                        <div style={{ textAlign: "right", fontSize: "12px", color: "#666", marginTop: "5px" }}>
                                            Paletten: {frachtkosten.paletten}
                                        </div>
                                    )}
                                    {artikelListe.length > 0 && (
                                        <button
                                            type="button"
                                            onClick={berechneSendungsVersandkosten}
                                            style={{
                                                width: "100%",
                                                marginTop: "10px",
                                                fontWeight: "bold",
                                                background: "linear-gradient(90deg, #1a3b6e 60%, #2c5282 100%)",
                                                color: "#fff",
                                                border: "none",
                                                borderRadius: "7px",
                                                padding: "8px 18px",
                                                cursor: "pointer",
                                                fontSize: "13px"
                                            }}
                                        >
                                            Fracht berechnen
                                        </button>
                                    )}
                                </div>
                                {!versandAktiv && (
                                    <div style={{
                                        position: 'absolute',
                                        top: 0, left: 0, right: 0, bottom: 0,
                                        background: 'rgba(240,240,240,0.5)',
                                        zIndex: 2,
                                        pointerEvents: 'none',
                                        borderRadius: '8px'
                                    }} />
                                )}
                            </fieldset>
                            <fieldset className="form-section" style={{ minWidth: '140px', flex: '0.6 1 0' }}>
                                <legend>Lagerung</legend>
                                <label>Anzahl Paletten:
                                    <input type="number" value={aktuellesErgebnis.anzahlPaletten || 0} readOnly />
                                </label>
                                <label>Lagerdauer (Monate):
                                    <input type="number" value={lagerDauer} onChange={e => setLagerDauer(e.target.value)} />
                                </label>
                                <label>Lagergebühr je Palette/Monat (€):
                                    <input type="number" value={5.5} readOnly step="0.01" />
                                </label>
                                <div style={{ marginTop: 10, fontSize: 13, color: '#1a3b6e' }}>
                                    Gesamte Lagerkosten: <strong>€{formatDE(lagerkosten.gesamt)}</strong><br />
                                    Lagerkosten je Preiseinheit: <strong>€{formatDE(lagerkosten.proEinheit)}</strong>
                                </div>
                            </fieldset>
                        </div>

                        {/* Artikelliste und Frachtverteilung */}
                        {artikelListe.length > 0 && (
                            <div style={{ marginTop: "30px" }} id="artikel-tabelle">
                                <div style={{ marginBottom: "10px", color: "#1a3b6e", fontWeight: "bold" }}>
                                    Artikel in der Sendung: {artikelListe.length}
                                </div>
                                <div style={{
                                    overflowX: "auto",
                                    background: "#f5f7fa",
                                    border: "1px solid #bfc9d1",
                                    borderRadius: "8px",
                                    boxShadow: "0 1px 2px 0 rgba(30,60,90,0.03)",
                                    padding: "8px",
                                    maxWidth: "1400px",
                                    margin: "0 auto"
                                }}>
                                    <table style={{
                                        borderCollapse: "collapse",
                                        width: "100%",
                                        fontSize: "0.90em",
                                        background: "#fff",
                                        borderRadius: "8px",
                                        overflow: "hidden"
                                    }}>
                                        <thead>
                                            <tr style={{ background: "#e3e8ee", color: "#1a3b6e" }}>
                                                <th style={{ borderRight: "1px solid #bfc9d1", padding: "6px" }}>Angebotsnummer</th>
                                                <th style={{ borderRight: "1px solid #bfc9d1", padding: "6px" }}>Kundenname</th>
                                                <th style={{ borderRight: "1px solid #bfc9d1", padding: "6px" }}>Menge</th>
                                                <th style={{ borderRight: "1px solid #bfc9d1", padding: "6px" }}>Paletten</th>
                                                <th style={{ borderRight: "1px solid #bfc9d1", padding: "6px" }}>EK je PE</th>
                                                <th style={{ borderRight: "1px solid #bfc9d1", padding: "6px" }}>Einkaufssumme</th>
                                                <th style={{ borderRight: "1px solid #bfc9d1", padding: "6px" }}>Verkaufssumme</th>
                                                <th style={{ borderRight: "1px solid #bfc9d1", padding: "6px" }}>VK je PE</th>
                                                <th style={{ borderRight: "1px solid #bfc9d1", padding: "6px" }}>Aufschlag %</th>
                                                <th style={{ borderRight: "1px solid #bfc9d1", padding: "6px" }}>anteilige Fracht</th>
                                                <th style={{ padding: "6px" }}>DB gesamt</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {artikelMitFracht.map((a, i) => (
                                                <tr key={i} style={{
                                                    background: i % 2 === 0 ? "#f7fafc" : "#fff",
                                                    borderBottom: "1px solid #bfc9d1"
                                                }}>
                                                    <td style={{ borderRight: "1px solid #e3eefd", padding: "5px 6px" }}>{a.interneNummer}</td>
                                                    <td style={{ borderRight: "1px solid #e3eefd", padding: "5px 6px" }}>{a.kundenname}</td>
                                                    <td style={{ borderRight: "1px solid #e3eefd", padding: "5px 6px", textAlign: "right" }}>{a.mengeNum}</td>
                                                    <td style={{ borderRight: "1px solid #e3eefd", padding: "5px 6px", textAlign: "right" }}>{a.anzahlPaletten}</td>
                                                    <td style={{ borderRight: "1px solid #e3eefd", padding: "5px 6px", textAlign: "right" }}>€{formatDE(a.ekJePreiseinheit)}</td>
                                                    <td style={{ borderRight: "1px solid #e3eefd", padding: "5px 6px", textAlign: "right" }}>€{formatDE((a.ekJePreiseinheit || 0) * (a.mengeNum / (a.einheit || 1)))}</td>
                                                    <td style={{ borderRight: "1px solid #e3eefd", padding: "5px 6px", textAlign: "right" }}>€{formatDE((() => {
                                                        const ek = a.ekJePreiseinheit || 0;
                                                        const aufschlag = a.aufschlagProzent || 0;
                                                        const anteiligeFracht = a.anteiligeFracht || 0;
                                                        const mengeNum = a.mengeNum || 1;
                                                        const einheit = a.einheit || 1;
                                                        const neueVkJePE = ek * (1 + aufschlag / 100);
                                                        const vkJePEInklFracht = neueVkJePE + (anteiligeFracht / (mengeNum / einheit));
                                                        return vkJePEInklFracht * (mengeNum / einheit);
                                                    })())}</td>
                                                    <td style={{ borderRight: "1px solid #e3eefd", padding: "5px 6px", textAlign: "right", background: "#e3e8ee", color: "#1a3b6e", fontWeight: "bold", fontSize: "1.08em", boxShadow: "0 0 0 2px #388e3c22 inset" }}>€{formatDE((() => {
                                                        const ek = a.ekJePreiseinheit || 0;
                                                        const aufschlag = a.aufschlagProzent || 0;
                                                        const anteiligeFracht = a.anteiligeFracht || 0;
                                                        const mengeNum = a.mengeNum || 1;
                                                        const einheit = a.einheit || 1;
                                                        const neueVkJePE = ek * (1 + aufschlag / 100);
                                                        // Lagerkosten pro Einheit berücksichtigen
                                                        return neueVkJePE + (anteiligeFracht / (mengeNum / einheit)) + (a.lagerkostenProEinheit || 0);
                                                    })())}</td>
                                                    <td style={{ borderRight: "1px solid #e3eefd", padding: "5px 6px", textAlign: "right" }}>
                                                        <input type="number" className="input-aufschlag-prozent" value={a.aufschlagProzent !== undefined ? a.aufschlagProzent : ''} min="0" max="100" step="0.01"
                                                            style={{ width: '60px', fontSize: '1em', textAlign: 'right', border: '1px solid #bfc9d1', borderRadius: '4px', color: '#1a3b6e', background: '#f7fafc' }}
                                                            onFocus={e => e.target.select()}
                                                            onMouseUp={e => { e.preventDefault(); e.target.select(); }}
                                                            onChange={e => {
                                                                const newValue = parseFloat(e.target.value) || 0;
                                                                setArtikelListe(prev => prev.map((art, idx2) => {
                                                                    if (i === idx2) {
                                                                        return {
                                                                            ...art,
                                                                            aufschlagProzent: newValue
                                                                        };
                                                                    }
                                                                    return art;
                                                                }));
                                                                // Trigger ein Re-Render der gesamten Tabelle, indem ein Dummy-State geändert wird
                                                                setDummyState(s => s + 1);
                                                            }}
                                                        />
                                                    </td>
                                                    <td style={{ borderRight: "1px solid #e3eefd", padding: "5px 6px", textAlign: "right" }}>{a.anteiligeFracht > 0 ? "€" + formatDE(a.anteiligeFracht) : "-"}</td>
                                                    <td style={{ fontWeight: "bold", color: "#1a3b6e", background: "#e3e8ee", padding: "5px 6px", textAlign: "right" }}>€{formatDE((() => {
                                                        const ek = a.ekJePreiseinheit || 0;
                                                        const aufschlag = a.aufschlagProzent || 0;
                                                        const mengeNum = a.mengeNum || 0;
                                                        const einheit = a.einheit || 1;
                                                        const neueVkJePE = ek * (1 + aufschlag / 100);
                                                        const dbJePE = neueVkJePE - ek;
                                                        return dbJePE * (mengeNum / einheit);
                                                    })())}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                        <div className="button-row">
                            <button type="button" onClick={saveKalkulation}>Kalkulation speichern</button>
                            <button type="button" onClick={async () => {
                                if (!showDatabase) {
                                    await loadKalkulationen();
                                    setShowDatabase(true);
                                } else {
                                    setSavedCalculations([]);
                                    setShowDatabase(false);
                                }
                            }} style={{marginLeft:10}}>
                                {showDatabase ? 'Datenbank ausblenden' : 'Datenbank anzeigen'}
                            </button>
                        </div>
                        {showDatabase && <DatabaseTable />}
                    </form>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<App />);
    </script>
    <div class="version">Version 1.0.7</div>
</body>
</html> 